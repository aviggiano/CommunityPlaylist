<!doctype HTML>
<html>
    <head>
        <title>Community Playlist</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}" type="text/css" />
    </head>
    <body>
        <div id="container">
            <span id="title">Community PlayList</span>
            <br>
         {% if session.logged_in %}
         You are the boss!!!<br>
        <div id="player"></div>
        <br>
        <a href="/logout" id="logout">Logout</a>
        <br>
        <input id="startPL" type="submit" value=Start>
        <input id="pausePL" type="submit" value=Pause>
        <input id="next" type="submit" value=">>">
        {% else %}
        <br>
        <a href="/login" id="login">Login</a>
        {% endif %}
		<br>
        <span id="now_playing"></span>
        <br>
        <input id="newSongUrl" type="text" />
        <input id="addNewSong" type="submit" value="Add"/>
		<!--
        <br>
	    <input id="upd" type="submit" value="Atualizar">
		//-->
        <br>
 		<ul id="show-items"></ul>
         {% if session.logged_in %}
            <a href="#" id="clear-all">Clear All</a>
        {% endif %}
        </div>
        <script src="js/jquery-1.4.4.min.js"></script>
        <script src="js/jquery-ui-1.8.7.custom.min.js"></script>
        <script src="js/jquery.inlineedit.js"></script>
        <script src="js/pubsub.js"></script>
        <script src="js/base.js"></script>
        <script>
            //Load player api asynchronously.
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[5];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            var player;
            var default_start_video = 'dQw4w9WgXcQ'
            var default_next_video = 'RFhNJ8ozDBk'
            var song_playing = default_start_video

            function onYouTubeIframeAPIReady() {
                player = new YT.Player('player', {
                  height: '390',
                  width: '640',
                  videoId: default_start_video,
                  events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                  }
                });
            }
            function checkValidUrl(url){
                if(url == null){
                    return 0;
                }else{
                    return 1;
                }
            }
            $("#startPL").click(function(){
                if(player.getPlayerState() == YT.PlayerState.PAUSED){
                    player.playVideo();
                }
            });

            $("#pausePL").click(function(){
                player.pauseVideo();
            });

            $("#next").click(function(){
                playNextVideo();
            });
            function playVideoByUrl(url){
                player.loadVideoByUrl(url);
            };

           function playNextVideo(){
                $.getJSON( SCRIPT_ROOT + '/_next',
                        {},
                        function(item){
                            console.log("Proximo video "+item);
                            if(item != null){
                                song_playing = item;
                            }else{
                                song_playing = default_next_video
                            }
                                player.loadVideoById(song_playing)
                                update_status_function();
                                update_function();
                        })
            };
            function onPlayerReady(evt) {
                console.log('playing '+playing)
                //if(playing)
                    evt.target.playVideo();
            };

            function updateStatus(song_title,status){
                $.getJSON( SCRIPT_ROOT + '/_set_playing',
                    {'now_playing':status,
                     'song_playing':song_title},
                     function(){

                     }
                    );
            }

            function onPlayerStateChange(evt) {
                console.log('new state '+evt.data)

                if(evt.data == YT.PlayerState.PLAYING){
                    get_video_data(song_playing,
                        function(data,status,xhr){
                            updateStatus(data.data.title,1);
                    });
                }else if (evt.data == YT.PlayerState.ENDED) {
                    playNextVideo();
                }else{
                    get_video_data(song_playing,
                        function(data,status,xhr){
                            updateStatus(data.data.title,0);
                    });
                }
            };
            function stopVideo() {
                player.stopVideo();
            };
        </script>
    </body>
</html>
